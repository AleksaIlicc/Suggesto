<!doctype html>
<html lang="en">
  <head>
    <title><%= app.name %> - Suggesto</title>
    <%- include('../../shared/includes/meta') %> <%-
    include('../../shared/includes/styles') %>
  </head>
  <body id="pageBody" class="bg-background">
    <% if (isOwner) { %>
    <div class="fixed right-8 bottom-8">
      <a
        href="/apps"
        class="flex h-14 w-14 items-center justify-center rounded-full bg-white shadow-md">
        <i class="fas fa-th text-gray-dark text-xl"></i>
      </a>
    </div>
    <% } %>
    <div
      id="appHeader"
      class="flex justify-center p-6 shadow-sm sm:px-28 sm:py-14">
      <div class="flex w-full max-w-xl flex-col justify-center space-y-3">
        <div class="flex items-center space-x-4">
          <div
            class="flex h-10 w-10 items-center justify-center rounded-full bg-white">
            <% if (app.design && app.design.logo) { %>
            <img
              src="<%= app.design.logo %>"
              alt="<%= app.name %>"
              class="h-full w-full rounded-full object-cover" />
            <% } else { %>
            <span class="text-lg font-medium text-black"
              ><%= app.name.charAt(0) %></span
            >
            <% } %>
          </div>
          <h1 class="text-lg font-medium text-white sm:text-xl">
            <%= app.name %>
          </h1>
        </div>

        <p class="max-w-2xl text-sm text-gray-100 sm:text-base">
          <%= app.description %>
        </p>
      </div>
    </div>

    <main class="w-full flex justify-center p-6 sm:px-28 sm:py-8">
      <div class="w-full max-w-xl">
        <div class="mb-4 w-full sm:mb-8">
          <div class="flex flex-col space-y-3 sm:flex-row sm:space-x-3 sm:space-y-0">
            <button
              id="addSuggestionBtn"
              onclick="window.location.href = '<%= app._id %>/add-suggestion'"
              class="cursor-pointer rounded-xl px-6 py-3 text-base text-white transition-all hover:opacity-90 active:scale-95">
              Add Suggestion
            </button>
            <% if (app.enablePublicRoadmap) { %>
            <button
              id="viewRoadmapBtn"
              onclick="window.location.href = '/apps/<%= app._id %>/roadmap'"
              class="cursor-pointer rounded-xl px-6 py-3 text-base text-white transition-all hover:opacity-90 active:scale-95">
              View Roadmap
            </button>
            <% } %>
          </div>
        </div>

        <!-- Suggestions Header with Dropdown -->
        <div class="mb-6 flex items-center justify-between">
          <h2 class="text-xl font-semibold flex items-center" <% /* eslint-disable css-propertyvalueexpected */ %> style="color: <%= app.design?.suggestionsHeaderColor %>">
            Showing 
            <select 
              id="sortDropdown"
              onchange="changeSorting(this.value)"
              class="mx-2 px-3 py-1 rounded-md border-b border-gray-300 text-xl font-semibold cursor-pointer focus:outline-none"
              <% /* eslint-disable css-propertyvalueexpected */ %> style="color: <%= app.design?.suggestionsHeaderColor %>; background-color: <%= app.design?.backgroundColor %>;">
              <option value="top" <%= currentSort === 'top' || !currentSort ? 'selected' : '' %>>Top</option>
              <option value="trending" <%= currentSort === 'trending' ? 'selected' : '' %>>Trending</option>
              <option value="new" <%= currentSort === 'new' ? 'selected' : '' %>>New</option>
            </select>
            suggestions
          </h2>
        </div>

        <div class="w-full space-y-4">
          <% if (suggestions && suggestions.length > 0) { %> <%
          suggestions.forEach(suggestion => { %>
          <div class="rounded-xl p-4 shadow-sm sm:p-6 cursor-pointer transition-all hover:shadow-md" 
               onclick="window.location.href = '/apps/<%= app._id %>/suggestions/<%= suggestion._id %>'"
               <% /* eslint-disable css-propertyvalueexpected */ %> style="background-color: <%= app.design?.suggestionCardBgColor %>">
            <div class="mb-3 flex flex-wrap items-center gap-2">
              <% if (suggestion.category) { %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white" 
                 <% /* eslint-disable css-propertyvalueexpected */ %> style="background-color: <%= suggestion.category.color %>">
                  <%= suggestion.category.name.charAt(0).toUpperCase() + suggestion.category.name.slice(1) %>
                </span>
              <% } %>

              <span class="text-xs" <% /* eslint-disable css-propertyvalueexpected */ %> style="color: <%= app.design?.suggestionMetaColor %>">
                by <%= suggestion.userId ? `${suggestion.userId.firstName} ${suggestion.userId.lastName}` : 'Anonymous User' %> â€¢ 
                <%= moment(suggestion.createdAt).format('MMM DD, YYYY') %>
              </span>
            </div>
            
            <div
              class="flex flex-col space-y-2 space-x-0 sm:flex-row sm:items-start sm:justify-between sm:space-y-0 sm:space-x-4">
              <div class="flex-1">
                <h3 class="text-base font-medium sm:text-lg mb-2" <% /* eslint-disable css-propertyvalueexpected */ %> style="color: <%= app.design?.suggestionTextColor %>">
                  <%= suggestion.title %>
                </h3>
                <% 
                  // Truncate description to approximately 4 lines (roughly 200 characters)
                  const truncatedDescription = suggestion.description.length > 200 
                    ? suggestion.description.substring(0, 200) + '...' 
                    : suggestion.description;
                %>
                <p class="text-sm sm:text-base mb-3" <% /* eslint-disable css-propertyvalueexpected */ %> style="color: <%= app.design?.suggestionTextColor %>">
                  <%= truncatedDescription %>
                  <% if (suggestion.description.length > 200) { %>
                    <span class="underline" style="color: <%= app.design?.backButtonColor %>">Read more</span>
                  <% } %>
                </p>
                
                <% if (suggestion.files && suggestion.files.length > 0) { %>
                  <div class="mb-3">
                    <div class="flex items-center text-sm text-gray-600">
                      <i class="fas fa-paperclip mr-1"></i>
                      <span><%= suggestion.files.length %> attachment<%= suggestion.files.length > 1 ? 's' : '' %></span>
                    </div>
                  </div>
                <% } %>
              </div>
              
              <div class="flex items-center justify-end space-x-3">
                <div class="flex items-center space-x-2">
                  <button
                    onclick="event.stopPropagation(); toggleVote('<%= suggestion._id %>')"
                    id="vote-btn-<%= suggestion._id %>"
                    class="flex items-center cursor-pointer space-x-2 rounded-lg p-2 transition-all hover:opacity-90 active:scale-95"
                    <% /* eslint-disable css-propertyvalueexpected */ %> style="background-color: <%= app.design?.voteButtonBgColor %>; color: <%= app.design?.voteButtonTextColor %>; border: 1px solid <%= suggestion.hasUserVoted ? (app.design?.voteButtonTextColor || '#374151') : 'transparent' %>">
                    <i class="fas fa-chevron-up text-md"></i>
                    <p class="text-sm font-medium sm:text-base" id="vote-count-<%= suggestion._id %>"
                       <% /* eslint-disable css-propertyvalueexpected */ %> style="color: <%= app.design?.voteButtonTextColor %>">
                      <%= suggestion.voteCount || 0 %>
                    </p>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <% }) %> <% } else { %>
          <div class="text-center text-gray-500 py-8">
            <p class="text-lg mb-2">No suggestions yet</p>
            <p class="text-sm">Be the first to suggest something!</p>
          </div>
          <% } %>
        </div>
      </div>
    </main>

    <%- include('../../shared/includes/scripts') %>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const headerColor = '<%= app.design?.headerColor %>';
        const headerTextColor = '<%= app.design?.headerTextColor %>';
        const buttonColor = '<%= app.design?.buttonColor %>';
        const buttonTextColor = '<%= app.design?.buttonTextColor %>';
        const backButtonColor = '<%= app.design?.backButtonColor %>';
        const backgroundColor = '<%= app.design?.backgroundColor %>';

        // Helper function for safe style application
        const safeApplyStyle = (element, property, value) => {
          if (element && value) {
            element.style[property] = value;
          }
        };

        // Apply header styles
        const header = document.getElementById('appHeader');
        safeApplyStyle(header, 'backgroundColor', headerColor);
        
        // Apply header text colors
        const headerTitle = header ? header.querySelector('h1') : null;
        const headerDescription = header ? header.querySelector('p') : null;
        safeApplyStyle(headerTitle, 'color', headerTextColor);
        safeApplyStyle(headerDescription, 'color', headerTextColor);

        // Apply button styles
        const addButton = document.getElementById('addSuggestionBtn');
        safeApplyStyle(addButton, 'backgroundColor', buttonColor);
        safeApplyStyle(addButton, 'color', buttonTextColor);

        // Style View Roadmap button with same colors
        const roadmapButton = document.getElementById('viewRoadmapBtn');
        safeApplyStyle(roadmapButton, 'backgroundColor', buttonColor);
        safeApplyStyle(roadmapButton, 'color', buttonTextColor);

        // Apply background colors
        const mainElement = document.querySelector('main');
        safeApplyStyle(mainElement, 'backgroundColor', backgroundColor);

        // Set body background to custom color
        const bodyElement = document.getElementById('pageBody');
        safeApplyStyle(bodyElement, 'backgroundColor', backgroundColor);        
      });

      // Dropdown sorting function
      function changeSorting(sortValue) {
        window.location.href = '/apps/<%= app._id %>?sort=' + sortValue;
      }

      // Voting functionality
      async function toggleVote(suggestionId) {
        try {
          const response = await fetch(`/apps/api/suggestions/${suggestionId}/vote`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (data.success) {
            const voteBtn = document.getElementById(`vote-btn-${suggestionId}`);
            const voteCount = document.getElementById(`vote-count-${suggestionId}`);
            
            // Update vote count
            if (voteCount) {
              voteCount.textContent = data.voteCount;
            }
            
            // Get design colors
            const voteButtonBgColor = '<%= app.design?.voteButtonBgColor %>';
            const voteButtonTextColor = '<%= app.design?.voteButtonTextColor %>';

            // Update button appearance - background stays the same, add border if voted
            if (voteBtn) {
              voteBtn.style.backgroundColor = voteButtonBgColor;
              voteBtn.style.color = voteButtonTextColor;
              
              // Add border if voted, remove if not voted
              if (data.voted) {
                voteBtn.style.border = `2px solid ${voteButtonTextColor || '#374151'}`;
              } else {
                voteBtn.style.border = '2px solid transparent';
              }
            }
            
            // Update vote count color - always use the same text color
            if (voteCount) {
              voteCount.style.color = voteButtonTextColor;
            }
          } else {
            alert(data.message || 'Failed to process vote');
          }
        } catch (error) {
          console.error('Error voting:', error);
          alert('Failed to process vote. Please try again.');
        }
      }
    </script>
  </body>
</html>
