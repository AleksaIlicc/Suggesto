<!doctype html>
<html lang="en">
  <head>
    <title>Suggesto - Add Suggestion</title>
    <%- include('../../shared/includes/meta') %> <%-
    include('../../shared/includes/styles') %>
  </head>
  <body class="bg-background">
    <main class="mx-auto flex justify-center px-4 py-4 sm:px-28 sm:py-8">
      <form
        action="/apps/<%= appId %>/add-suggestion"
        method="post"
        enctype="multipart/form-data"
        class="bg-primary w-full max-w-md space-y-6 rounded-xl p-10">
        <h2 class="text-center text-2xl">Add suggestion</h2>
        <div class="space-y-4">
          <div>
            <label for="title" class="block text-sm font-medium text-gray-700"
              >Title</label
            >
            <input
              type="text"
              id="title"
              name="title"
              required
              class="mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:border-black focus:ring-2 focus:ring-black focus:outline-none"
              autocomplete="false" />
          </div>
          <div>
            <label
              for="description"
              class="block text-sm font-medium text-gray-700"
              >Description</label
            >
            <input
              type="text"
              id="description"
              name="description"
              required
              class="mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:border-black focus:ring-2 focus:ring-black focus:outline-none"
              autocomplete="false" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Media Files</label
            >
            <div class="mt-1 w-full">
              <div
                id="uploadContainer"
                class="relative rounded-xl border-2 border-dashed border-gray-300 p-8 text-center transition-colors hover:border-gray-400">
                <input
                  type="file"
                  id="mediaFiles"
                  name="mediaFiles"
                  multiple
                  accept="image/*,video/*"
                  class="absolute inset-0 h-full w-full cursor-pointer opacity-0" />
                <div class="space-y-2">
                  <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                  <p class="text-sm font-medium text-gray-700">
                    Drag and drop files here
                  </p>
                  <p class="text-xs text-gray-500">or click to select files</p>
                  <p class="text-xs text-gray-500">
                    (Max 3 files, images or videos)
                  </p>
                </div>
              </div>

              <div
                id="previewContainer"
                class="mt-4 grid hidden grid-cols-2 gap-4 sm:grid-cols-3"></div>

              <p
                id="errorMessage"
                class="text-gray-dark mt-2 hidden text-sm"></p>
            </div>
          </div>
        </div>
        <button
          type="submit"
          class="bg-gray-dark hover:bg-gray-light w-full cursor-pointer rounded-xl py-2 text-white transition-colors duration-300 ease-in-out hover:text-white focus:ring-2 focus:ring-black focus:outline-none">
          Add Suggestion
        </button>
      </form>
    </main>

    <%- include('../../shared/includes/scripts') %>
    <script>
      const mediaFiles = document.getElementById('mediaFiles');
      const previewContainer = document.getElementById('previewContainer');
      const errorMessage = document.getElementById('errorMessage');
      const uploadContainer = document.getElementById('uploadContainer');
      let selectedFiles = [];

      mediaFiles.addEventListener('change', handleFileSelect);
      uploadContainer.addEventListener('dragover', e => e.preventDefault());
      uploadContainer.addEventListener('drop', handleFileDrop);

      function handleFileDrop(e) {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
      }

      function handleFileSelect(e) {
        handleFiles(e.target.files);
        e.target.value = '';
      }
      function isFileDuplicate(file) {
        return selectedFiles.some(
          existingFile =>
            existingFile.name === file.name && existingFile.size === file.size
        );
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
        mediaFiles.value = '';
      }

      function handleFiles(files) {
        const newFiles = Array.from(files);

        if (selectedFiles.length + newFiles.length > 3) {
          showError('Maximum 3 files allowed');
          return;
        }

        for (const file of newFiles) {
          if (isFileDuplicate(file)) {
            showError('File already added: ' + file.name);
            return;
          }
        }

        errorMessage.classList.add('hidden');
        selectedFiles = [...selectedFiles, ...newFiles].slice(0, 3);
        updatePreviews();
      }

      function updatePreviews() {
        previewContainer.innerHTML = '';

        if (selectedFiles.length > 0) {
          previewContainer.classList.remove('hidden');
        } else {
          previewContainer.classList.add('hidden');
        }

        selectedFiles.forEach((file, index) => {
          const preview = document.createElement('div');
          preview.className = 'relative aspect-square';

          if (file.type.startsWith('image/')) {
            preview.innerHTML = `
              <img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover rounded-lg" />
              <button onclick="removeFile(${index})" class="absolute cursor-pointer top-2 right-2 bg-gray-dark text-white rounded-full w-6 h-6 flex items-center justify-center">
                <i class="fas fa-times"></i>
              </button>
              <div class="absolute bottom-2 right-2 bg-gray-dark bg-opacity-75 rounded-full w-6 h-6 flex items-center justify-center">
                <i class="fas fa-image text-white text-sm"></i>
              </div>
            `;
          } else if (file.type.startsWith('video/')) {
            preview.innerHTML = `
              <video src="${URL.createObjectURL(file)}" class="w-full h-full object-cover rounded-lg"></video>
              <button onclick="removeFile(${index})" class="absolute cursor-pointer top-2 right-2 bg-gray-dark text-white rounded-full w-6 h-6 flex items-center justify-center">
                <i class="fas fa-times"></i>
              </button>
              <div class="absolute bottom-2 right-2 bg-gray-dark bg-opacity-75 rounded-full w-6 h-6 flex items-center justify-center">
                <i class="fas fa-video text-white text-sm"></i>
              </div>
            `;
          }

          previewContainer.appendChild(preview);
        });

        const formData = new FormData();
        selectedFiles.forEach((file, index) => {
          formData.append(`media${index}`, file);
        });
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        mediaFiles.value = '';
        updatePreviews();
      }
    </script>
  </body>
</html>
