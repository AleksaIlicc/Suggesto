<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../../shared/includes/meta') %>
    <title><%= roadmapItem.title %> - <%= app.name %> Roadmap</title>
    <%- include('../../shared/includes/styles') %>
  </head>

  <body id="pageBody" class="bg-background">
    <% if (isOwner) { %>
    <div class="fixed right-8 bottom-8">
      <a
        href="/apps"
        class="flex h-14 w-14 items-center justify-center rounded-full bg-white shadow-md">
        <i class="fas fa-th text-gray-dark text-xl"></i>
      </a>
    </div>
    <% } %>

    <!-- Header Section -->
    <div
      id="appHeader"
      class="flex justify-center p-6 shadow-sm sm:px-28 sm:py-14">
      <div class="flex w-full max-w-xl flex-col justify-center space-y-3">
        <div class="flex items-center space-x-4">
          <div
            class="flex h-10 w-10 items-center justify-center rounded-full bg-white">
            <% if (app.design && app.design.logo) { %>
            <img
              src="<%= app.design.logo %>"
              alt="<%= app.name %>"
              class="h-full w-full rounded-full object-cover" />
            <% } else { %>
            <span class="text-lg font-medium text-black"
              ><%= app.name.charAt(0) %></span
            >
            <% } %>
          </div>
          <h1 class="text-lg font-medium text-white sm:text-xl">
            <%= app.name %> - Roadmap
          </h1>
        </div>

        <p class="max-w-2xl text-sm text-gray-100 sm:text-base">
          <%= app.description %>
        </p>
      </div>
    </div>

    <main class="mx-auto flex justify-center p-6 sm:px-28 sm:py-8">
      <div class="w-full max-w-xl">
        <!-- Back Button -->
        <div class="mb-6 flex justify-start">
          <a
            href="/apps/<%= app._id %>/roadmap"
            class="flex items-center transition-colors"
            id="backButton">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Roadmap
          </a>
        </div>

        <!-- Roadmap Item Detail Card -->
        <div class="rounded-xl p-6 shadow-sm" id="detailCard">
          <!-- Header with Status and Actions -->
          <div class="mb-6 flex items-start justify-between">
            <div class="flex-1">
              <div class="mb-3 flex items-center space-x-3">
                <!-- Status Badge -->
                <span
                  class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium"
                  id="statusBadge">
                  <i class="fas fa-circle mr-2 text-xs"></i>
                  <%= roadmapItem.status.charAt(0).toUpperCase() + roadmapItem.status.slice(1).replace('-', ' ') %>
                </span>

                <!-- Type Badge -->
                <% if (roadmapItem.type) { %>
                <span
                  class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium"
                  id="typeBadge">
                  <%= roadmapItem.type.charAt(0).toUpperCase() + roadmapItem.type.slice(1).replace('-', ' ') %>
                </span>
                <% } %>

                <!-- Priority Indicator -->
                <% if (roadmapItem.priority) { %>
                <span class="text-sm" id="priorityText">
                  <%= roadmapItem.priority.charAt(0).toUpperCase() + roadmapItem.priority.slice(1) %> priority
                </span>
                <% } %>
              </div>

              <h1 class="text-xl font-semibold sm:text-2xl" id="itemTitle">
                <%= roadmapItem.title %>
              </h1>
            </div>

            <% if (isOwner) { %>
            <div class="ml-4 flex flex-shrink-0 space-x-2">
              <a
                href="/apps/<%= app._id %>/roadmap/<%= roadmapItem._id %>/edit"
                class="flex items-center rounded-lg px-3 py-2 text-sm transition-colors"
                id="editButton">
                <i class="fas fa-edit mr-2"></i>
                Edit
              </a>
              <button
                onclick="deleteRoadmapItem('<%= roadmapItem._id %>')"
                class="flex cursor-pointer items-center rounded-lg px-3 py-2 text-sm transition-colors"
                id="deleteButton">
                <i class="fas fa-trash mr-2"></i>
                Delete
              </button>
            </div>
            <% } %>
          </div>

          <!-- Description -->
          <div class="mb-6">
            <div class="prose prose-sm max-w-none" id="descriptionText">
              <%= roadmapItem.description %>
            </div>
          </div>

          <!-- Related Suggestion -->
          <% if (roadmapItem.suggestion) { %>
          <div class="mb-6">
            <h3 class="mb-3 text-lg font-medium" id="suggestionHeader">
              Related Suggestion
            </h3>
            <div
              class="rounded-lg border p-4 transition-colors"
              id="suggestionCard">
              <div class="mb-3 flex items-start justify-between">
                <div class="flex-1">
                  <h4 class="font-medium" id="suggestionTitle">
                    <a
                      href="/apps/<%= app._id %>/suggestions/<%= roadmapItem.suggestion._id %>"
                      class="hover:underline"
                      id="suggestionLink">
                      <%= roadmapItem.suggestion.title %>
                    </a>
                  </h4>
                  <% if (roadmapItem.suggestion.category && roadmapItem.suggestion.category.name) { %>
                  <span
                    id="categoryBadge"
                    class="mt-2 inline-flex items-center rounded-full px-2 py-1 text-xs font-medium">
                    <%= roadmapItem.suggestion.category.name %>
                  </span>
                  <% } %>
                </div>
                <div class="ml-4 flex items-center">
                  <div
                    class="flex items-center space-x-2 text-sm"
                    id="voteInfo">
                    <i class="fas fa-arrow-up"></i>
                    <span class="font-medium">
                      <%= roadmapItem.suggestion.voteCount || 0 %>
                    </span>
                  </div>
                </div>
              </div>

              <p class="mb-3 line-clamp-2 text-sm" id="suggestionDescription">
                <%= roadmapItem.suggestion.description %>
              </p>

              <div
                class="flex items-center justify-between text-xs"
                id="suggestionMeta">
                <div>
                  <% if (roadmapItem.suggestion.userId) { %> Suggested by
                  <span class="font-medium"
                    ><%= roadmapItem.suggestion.userId.firstName %> <%= roadmapItem.suggestion.userId.lastName %></span
                  >
                  â€¢ <% } %> <%= moment(roadmapItem.suggestion.createdAt).format('MMM DD, YYYY') %>
                </div>

                <a
                  href="/apps/<%= app._id %>/suggestions/<%= roadmapItem.suggestion._id %>"
                  class="inline-flex items-center hover:underline"
                  id="viewDetailsLink">
                  <span>View Details</span>
                  <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                </a>
              </div>
            </div>
          </div>
          <% } %>

          <!-- Simple Date Info -->
          <div>
            <div class="text-xs text-gray-500" id="dateInfo">
              <div>
                Created <%= moment(roadmapItem.createdAt).format('MMM DD, YYYY') %>
              </div>
              <% if (roadmapItem.estimatedReleaseDate) { %>
              <div>
                Estimated release date <%= moment(roadmapItem.estimatedReleaseDate).format('MMM DD, YYYY') %>
              </div>
              </div>
              <% } %>
            </div>
          </div>

        </div>
      </div>
    </main>

    <%- include('../../shared/includes/scripts') %>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Apply custom app design colors
        const backgroundColor = '<%= app.design?.backgroundColor %>';
        const headerColor = '<%= app.design?.headerColor %>';
        const headerTextColor = '<%= app.design?.headerTextColor %>';
        const buttonColor = '<%= app.design?.buttonColor %>';
        const buttonTextColor = '<%= app.design?.buttonTextColor %>';
        const backButtonColor = '<%= app.design?.backButtonColor %>';
        const cardBgColor = '<%= app.design?.suggestionCardBgColor %>';
        const textColor = '<%= app.design?.suggestionTextColor %>';
        const metaColor = '<%= app.design?.suggestionMetaColor %>';
        const suggestionsHeaderColor =
          '<%= app.design?.suggestionsHeaderColor %>';

        // Helper function for safe style application
        const safeApplyStyle = (element, property, value) => {
          if (element && value) {
            element.style[property] = value;
          }
        };

        // Apply header styles
        const headerElement = document.getElementById('appHeader');
        safeApplyStyle(headerElement, 'backgroundColor', headerColor);
        const headerTitle = headerElement
          ? headerElement.querySelector('h1')
          : null;
        const headerDescription = headerElement
          ? headerElement.querySelector('p')
          : null;
        safeApplyStyle(headerTitle, 'color', headerTextColor);
        safeApplyStyle(headerDescription, 'color', headerTextColor);

        // Apply body and main background
        const bodyElement = document.getElementById('pageBody');
        const mainElement = document.querySelector('main');
        safeApplyStyle(bodyElement, 'backgroundColor', backgroundColor);
        safeApplyStyle(mainElement, 'backgroundColor', backgroundColor);

        // Style back button
        const backButton = document.getElementById('backButton');
        safeApplyStyle(backButton, 'color', backButtonColor);
        if (backButton) {
          backButton.addEventListener('mouseenter', () => {
            backButton.style.setProperty('color', backButtonColor, 'important');
          });
          backButton.addEventListener('mouseleave', () => {
            backButton.style.setProperty('color', backButtonColor, 'important');
          });
        }

        // Style main detail card
        const detailCard = document.getElementById('detailCard');
        safeApplyStyle(detailCard, 'backgroundColor', cardBgColor);

        // Style all text elements
        const itemTitle = document.getElementById('itemTitle');
        const descriptionText = document.getElementById('descriptionText');
        const suggestionHeader = document.getElementById('suggestionHeader');
        const dateInfo = document.getElementById('dateInfo');

        safeApplyStyle(itemTitle, 'color', textColor);
        safeApplyStyle(descriptionText, 'color', textColor);
        safeApplyStyle(suggestionHeader, 'color', suggestionsHeaderColor);
        safeApplyStyle(dateInfo, 'color', metaColor);

        // Style badges
        const statusBadge = document.getElementById('statusBadge');
        const typeBadge = document.getElementById('typeBadge');
        const priorityText = document.getElementById('priorityText');

        safeApplyStyle(statusBadge, 'backgroundColor', buttonColor + '20');
        safeApplyStyle(statusBadge, 'color', buttonColor);
        safeApplyStyle(typeBadge, 'backgroundColor', metaColor + '20');
        safeApplyStyle(typeBadge, 'color', metaColor);
        safeApplyStyle(priorityText, 'color', metaColor);

        // Style suggestion card elements (only if suggestion exists)
        const suggestionExists =
          '<%= roadmapItem.suggestion ? "true" : "false" %>';
        if (suggestionExists === 'true') {
          const suggestionCard = document.getElementById('suggestionCard');
          const suggestionTitle = document.getElementById('suggestionTitle');
          const suggestionLink = document.getElementById('suggestionLink');
          const suggestionDescription = document.getElementById(
            'suggestionDescription'
          );
          const suggestionMeta = document.getElementById('suggestionMeta');
          const viewDetailsLink = document.getElementById('viewDetailsLink');
          const voteInfo = document.getElementById('voteInfo');

          safeApplyStyle(suggestionCard, 'backgroundColor', cardBgColor);
          safeApplyStyle(suggestionCard, 'borderColor', metaColor + '40');
          safeApplyStyle(suggestionTitle, 'color', textColor);
          safeApplyStyle(suggestionLink, 'color', backButtonColor);
          safeApplyStyle(suggestionDescription, 'color', metaColor);
          safeApplyStyle(suggestionMeta, 'color', metaColor);
          safeApplyStyle(viewDetailsLink, 'color', backButtonColor);
          safeApplyStyle(voteInfo, 'color', metaColor);
        }

        // Style action buttons for owners
        const editButton = document.getElementById('editButton');
        const deleteButton = document.getElementById('deleteButton');
        safeApplyStyle(editButton, 'backgroundColor', metaColor + '20');
        safeApplyStyle(editButton, 'color', metaColor);
        safeApplyStyle(deleteButton, 'backgroundColor', metaColor + '20');
        safeApplyStyle(deleteButton, 'color', metaColor);

        // Set category badge color based on category
        const categoryBadge = document.getElementById('categoryBadge');
        if (categoryBadge) {
          const categoryColor =
            '<%= (roadmapItem.suggestion && roadmapItem.suggestion.category && roadmapItem.suggestion.category.color) ? roadmapItem.suggestion.category.color : "" %>';
          if (categoryColor) {
            safeApplyStyle(
              categoryBadge,
              'backgroundColor',
              categoryColor + '20'
            );
            safeApplyStyle(categoryBadge, 'color', categoryColor);
          }
        }
      });
    </script>

    <% if (isOwner) { %>
    <script>
      function deleteRoadmapItem(itemId) {
        if (confirm('Are you sure you want to delete this roadmap item?')) {
          fetch(`/apps/<%= app._id %>/roadmap/${itemId}`, {
            method: 'DELETE',
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json',
            },
          })
            .then(response => {
              if (response.ok) {
                return response.json();
              } else {
                return response.json().then(data => Promise.reject(data));
              }
            })
            .then(data => {
              if (data.message) {
                alert(data.message);
              }
              window.location.href = '/apps/<%= app._id %>/roadmap';
            })
            .catch(error => {
              console.error('Error:', error);
              let errorMessage;
              if (error.error) {
                errorMessage = error.error;
              } else {
                errorMessage =
                  'Failed to delete roadmap item. Please try again.';
              }
              alert(errorMessage);
            });
        }
      }
    </script>
    <% } %>
  </body>
</html>
